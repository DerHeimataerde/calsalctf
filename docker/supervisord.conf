[supervisord]
nodaemon=true
logfile=/dev/null
pidfile=/var/run/supervisord.pid

; Central defaults (can be overridden per program)
;stdout_logfile=/dev/stdout
;stderr_logfile=/dev/stderr
;stdout_logfile_maxbytes=0
;stderr_logfile_maxbytes=0

[program:init-data-perms]
command=/bin/sh -lc "mkdir -p /data /opt/ctfd/CTFd/uploads && chown -R ctfd:ctfd /data /opt/ctfd/CTFd/uploads"
autostart=true
autorestart=false
exitcodes=0
startsecs=0
priority=50
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:ctfd]
directory=/opt/ctfd
; Load .env into the environment, then exec gunicorn from venv
command=/bin/sh -lc "set -a && . /opt/ctfd/.env && set +a && exec /opt/ctfd/.venv/bin/gunicorn \
  -w 1 -k gthread --threads 4 \
  --timeout 120 --graceful-timeout 30 --keep-alive 5 \
  -b 127.0.0.1:8000 --log-level debug --access-logfile - --error-logfile - 'CTFd:create_app()'"
user=ctfd
autostart=true
autorestart=true
startretries=5
stopasgroup=true
killasgroup=true
stopsignal=TERM
stopwaitsecs=40
priority=200
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:nodeapp]
directory=/app
command=/usr/local/bin/node /app/app.js
user=nodeuser
autostart=true
autorestart=true
startretries=5
stopasgroup=true
killasgroup=true
stopsignal=TERM
priority=300
environment=NODE_ENV="production",PORT="3000",PATH="/usr/local/bin:/usr/bin:/bin"
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;" -c /etc/nginx/nginx.conf
autostart=true
autorestart=true
startretries=5
stopasgroup=true
killasgroup=true
stopsignal=QUIT
priority=400
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0

[program:ctfd-seeder]
; One-shot seeder; script itself should wait until CTFd is healthy
command=/bin/sh -lc "/usr/local/bin/seed-ctfd-once.sh"
autostart=true
autorestart=false
startsecs=0
priority=900
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
